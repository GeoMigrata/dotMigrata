name: Publish NuGet Package (Trusted Publishing)

on:
  push:
    tags:
      - 'v*'          # 推送形如 v1.0.0 的标签时自动发布
  workflow_dispatch:   # 允许手动触发

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production   # 与 NuGet 配置的 Environment 名字一致
    permissions:
      contents: read          # 读取仓库内容
      id-token: write         # OIDC 必须，用于 Trusted Publishing
      # 如果还需要上传 GitHub Packages，可加 packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Derive Version from Tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Fallback Version (Manual Dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # 手动运行可自定义版本（暂用日期+run号示例，可改为输入参数）
          VERSION="0.0.0-dev-${{ github.run_number }}"
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack
        run: dotnet pack src/GeoMigrata.Core/GeoMigrata.Core.csproj -c Release -p:Version=${PKG_VERSION} -o ./nupkg --no-build

      # 受信发布步骤（占位说明）
      # 当你已在 nuget.org 配置 Trusted Publishing 后，此处不需要静态 API KEY。
      # 如果 NuGet 官方提供了专用 Action，可替换为官方 Action。
      - name: Publish to NuGet (Trusted Publishing)
        run: |
          # 直接使用 dotnet nuget push；NuGet 后端根据 OIDC 信任关系允许发布
          for file in ./nupkg/*.nupkg; do
            echo "Publishing $file"
            dotnet nuget push "$file" --source https://api.nuget.org/v3/index.json --skip-duplicate
          done

      # 可选：推送符号包
      - name: Publish symbol packages (optional)
        run: |
          for file in ./nupkg/*.snupkg; do
            echo "Publishing symbol $file"
            dotnet nuget push "$file" --source https://api.nuget.org/v3/index.json --skip-duplicate || true
          done