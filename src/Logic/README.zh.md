# 逻辑层文档

本目录包含模拟中用于计算吸引力、迁移流量和反馈效应的核心逻辑。

## 概述

逻辑层包含三个主要组件：

1. **Attraction（吸引力）** - 计算人口群体对城市的吸引力
2. **Migration（迁移）** - 根据吸引力差异确定迁移流量
3. **Feedback（反馈）** - 迁移后更新城市因素

---

## 吸引力计算器

### 算法概述

`AttractionCalculator` 根据城市的因素值和群体的敏感度计算城市对特定人口群体的吸引力。

### 计算步骤

1. **对于人口群体的每个因素敏感度：**
    - 检索该因素的城市因素值
    - 使用因素的标准化规则（线性、对数或 sigmoid）对因素值进行标准化
    - 确定因素类型（正面或负面）
        - 如果指定了 `OverriddenFactorType`，则使用敏感度中的覆盖类型
        - 否则使用因素定义的类型
    - 计算贡献：
        - **正面因素**：`贡献 = 标准化值 × 敏感度`
        - **负面因素**：`贡献 = -标准化值 × 敏感度`

2. **汇总所有贡献**以获得总吸引力分数

### 数学公式

```
吸引力分数 = Σ(贡献_i) 对于所有因素 i

其中：
  贡献_i = {
    标准化值_i × 敏感度_i     如果因素为正面
    -标准化值_i × 敏感度_i    如果因素为负面
  }
  
  标准化值_i = normalize(原始值_i, 因素_i)
```

### 标准化类型

- **线性（Linear）**：`(value - min) / (max - min)`
- **对数（Logarithmic）**：`log(value - min + δ) / log(max - min + δ)` 其中 δ = 1e-6
- **Sigmoid**：`1 / (1 + exp(-steepness × (linear - 0.5)))` 其中 steepness = 10.0

### 示例

对于人口群体"年轻专业人士"，具有以下敏感度：
- 收入（正面，敏感度：10）
- 污染（负面，敏感度：8）
- 公共服务（正面，敏感度：6）

对于具有标准化值的城市：
- 收入：0.7
- 污染：0.4
- 公共服务：0.8

吸引力分数 = (0.7 × 10) + (-0.4 × 8) + (0.8 × 6) = 7.0 - 3.2 + 4.8 = **8.6**

---

## 迁移计算器

### 算法概述

`MigrationCalculator` 根据吸引力差异、距离成本和概率抽样确定城市之间的实际迁移流量。

### 计算步骤

1. **对于每个目标城市**（不包括源城市）：

   a. **计算吸引力差异**：
   ```
   吸引力差异 = 目标吸引力 - 源吸引力
   ```

   b. **检查最小阈值**：
    - 如果 `吸引力差异 ≤ 最小吸引力阈值`（默认：0.1），则跳过

   c. **计算迁移成本**：
   ```
   距离 = haversineDistance(源城市, 目标城市)
   迁移成本 = 基础迁移成本 × 距离
   ```
    - `基础迁移成本` 默认：0.001

   d. **计算净吸引力**：
   ```
   净吸引力 = 吸引力差异 - 迁移成本
   ```
    - 如果 `净吸引力 ≤ 0`，则跳过

   e. **计算迁移概率**：
   ```
   基础概率 = 迁移意愿 × (1 - 保留率)
   吸引力因子 = tanh(净吸引力)
   迁移概率 = 基础概率 × 吸引力因子
   ```

   f. **抽样实际迁移人数**：
    - 对于小规模人口（≤100）：二项式抽样（每个人独立）
    - 对于大规模人口（>100）：二项式的正态近似
      ```
      均值 = 总人口 × 概率
      方差 = 总人口 × 概率 × (1 - 概率)
      标准差 = sqrt(方差)
      样本 = 均值 + 标准差 × N(0,1)  [使用 Box-Muller 变换]
      实际迁移人数 = clamp(round(样本), 0, 总人口)
      ```

2. **返回所有迁移流量**，其中 `实际迁移人数 > 0`

### 关键参数

- **BaseMigrationCost（基础迁移成本）**：0.001（每公里的成本）
- **MinimumAttractionThreshold（最小吸引力阈值）**：0.1（考虑的最小吸引力差异）
- **MovingWillingness（迁移意愿）**：群体特定（0-1）
- **RetentionRate（保留率）**：群体特定（0-1）

### 示例

对于具有以下属性的人口群体：
- 数量：10,000
- 迁移意愿：0.3
- 保留率：0.7

从城市 A（吸引力：5.0）到城市 B（吸引力：8.0）：
- 距离：500 公里
- 吸引力差异：3.0
- 迁移成本：0.001 × 500 = 0.5
- 净吸引力：3.0 - 0.5 = 2.5
- 基础概率：0.3 × (1 - 0.7) = 0.09
- 吸引力因子：tanh(2.5) ≈ 0.987
- 迁移概率：0.09 × 0.987 ≈ 0.089
- 预期迁移人数：10,000 × 0.089 = 890
- 实际迁移人数：~890（从正态分布中抽样）

---

## 反馈计算器

### 算法概述

`FeedbackCalculator` 根据人口变化在迁移后更新城市因素。这创建了一个反馈循环，迁移影响城市条件，进而影响未来的吸引力。

### 设计原则

1. **人口依赖效应**：因素根据人口比率变化
2. **平滑处理**：渐进变化以避免突然波动
3. **分类影响**：不同类型的因素响应方式不同

### 反馈类别

#### 1. 人均资源
分布在人口中的因素，如公共服务、医疗保健和教育：
- **效应**：与人口成反比
- **示例**：如果人口翻倍，人均服务质量下降

#### 2. 住房和拥挤
因素如住房成本、交通拥堵和污染：
- **效应**：随人口密度增加
- **示例**：更多人 → 住房需求增加 → 成本增加

#### 3. 经济因素
因素如经济产出、创新和就业机会：
- **效应**：与人口的复杂关系
- **正面**：更大的劳动力，更多创新
- **负面**：潜在的基础设施压力

### 平滑公式

为防止因素值的突然跳跃：

```
新值 = 当前值 + 平滑因子 × (目标值 - 当前值)
```

其中：
- `平滑因子` ∈ [0, 1]（默认：0.3）
- 更高的平滑因子 = 更渐进的变化

### 实现说明

当前的 `FeedbackCalculator` 提供了框架和平滑机制。实际的因素更新取决于每个模拟中定义的特定因素。用户可以根据其特定因素定义扩展此类或实现自定义反馈逻辑。

### 反馈规则示例（说明性）

对于经历 20% 人口增长的城市：

**人均资源：**
```
新公共服务 = smooth(当前值, 当前值 × 0.83)  // 约 17% 下降
```

**住房/拥挤：**
```
新住房成本 = smooth(当前值, 当前值 × 1.15)  // 约 15% 增加
新污染 = smooth(当前值, 当前值 × 1.10)    // 约 10% 增加
```

**经济：**
```
新经济产出 = smooth(当前值, 当前值 × 1.18)  // 约 18% 增加
```

这些特定比率将根据模拟的要求和每个因素的性质进行配置。

---

## 集成流程

三个组件在每个模拟步骤中协同工作：

```
1. AttractionCalculator.CalculateAttractionForAllCities()
   → 为每个城市-群体对生成吸引力分数

2. MigrationCalculator.CalculateMigrationFlows()
   → 根据吸引力生成迁移流量

3. 应用迁移（更新人口数量）

4. FeedbackCalculator.ApplyFeedback()
   → 根据新人口更新城市因素

5. 重复下一步
```

这创建了一个动态反馈系统，其中城市特征驱动迁移，而迁移随着时间推移重塑城市特征。