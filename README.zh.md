# dotGeoMigrata

dotGeoMigrata 是一个基于 C# .NET 9.0 的模拟框架，用于研究各因素对**多城市—人口群体系统**中的人口迁移与城市演化的影响。
该框架捕捉城市特征如何影响人口流动，以及迁移反馈如何随时间影响城市因素。

## 核心思想

主要模拟流程：

```text
城市因子 -> 人群偏好 -> 吸引力差异 -> 部分迁移 -> 城市反馈 -> 循环演化
```

人口迁移由城市因子驱动，同时迁移又反作用于城市因子，系统通过时间步迭代不断演化。

## 核心概念

- **世界（World）**：顶层实体，包含城市、因素定义及人口群体定义，维护全局因素定义、人口群体定义和城市当前状态。
- **城市（City）**：拥有因素值（如收入、污染、公共设施）及每个定义的人口群体对应的人口群体值。
  每个城市都必须具有在世界中定义的所有因素和所有人口群体对应的值。
- **因素定义与因素值（FactorDefinition & FactorValue）**：定义因素元数据，包括方向（拉力或推力）、标准化方式及取值范围。
  因素值内部会被标准化用于计算。每个城市都必须具有世界中所有因素定义对应的因素值。
- **群体定义与群体值（GroupDefinition & GroupValue）**：定义具有相似迁移行为的人口群体。
  群体定义指定迁移意愿、保留率以及对各因素的敏感度。群体值代表该群体在特定城市中的实际人口数量。
  每个城市都必须具有世界中所有群体定义对应的群体值（数量可以为 0）。这种设计允许在多个城市中重用相同的人口群体特征，无需重复创建。
- **吸引力（Attraction）**：计算某城市对某人口群体的净吸引力，考虑标准化因素值、群体敏感度和因素方向。
- **迁移（Migration）**：迁移判断基于吸引差、阈值及迁移成本，采用概率抽样实现迁移，同时考虑群体规模和城市容量。迁移不再是添加/删除人口群体，
  而是更新群体值中的人口数量。
- **城市反馈（City Feedback）**：迁移后城市因素根据反馈机制更新（人均资源、房价、拥挤/污染、产业/经济效应），通常通过平滑避免剧烈波动。

## 模拟流程

1. 初始化世界：设置城市、因素定义、群体定义和敏感度。
    - 每个群体定义必须包含对所有因素定义的敏感度
    - 每个城市必须具有所有因素定义对应的因素值
    - 每个城市必须具有所有群体定义对应的群体值
2. 每步模拟：
    - 标准化城市因子。
    - 对每个群体定义，计算所有城市的吸引力。
    - 计算迁移概率。
    - 按概率抽样得到实际迁移人数（考虑容量和保留率）。
    - 通过修改群体值的数量来更新城市人口构成。
    - 根据迁移反馈更新城市因子。
3. 重复至模拟结束（达到最大步数或系统稳定）。

## 安装与使用

克隆仓库并使用 Visual Studio 2022+ 打开，或使用 .NET 9.0 SDK。使用 `dotnet build` 构建项目。

这是一个库框架。要使用它，请在你的项目中引用 `dotGeoMigrata` 库并创建模拟：

1. 定义因素定义
2. 定义群体定义，包含对所有因素的敏感度
3. 创建城市，包含所有因素定义对应的因素值

4. 为每个城市创建所有群体定义对应的群体值
5. 创建计算器（或使用内置的 StandardModel）
6. 设置模拟阶段和配置
7. 创建模拟引擎并运行

## 架构

### 核心层（`/src/Core`）

包含基础领域模型：

- `World`, `City` - 实体模型
- `FactorDefinition`, `GroupDefinition` - 定义模型
- `FactorValue`, `GroupValue` - 值模型

### 逻辑层（`/src/Logic`）

提供计算接口和实现：

- `IAttractionCalculator` - 计算城市对群体的吸引力
- `IMigrationCalculator` - 确定迁移流
- `StandardAttractionCalculator` / `StandardMigrationCalculator` - 基于科学模型的默认实现

### 模拟层（`/src/Simulation`）

实现基于管线的模拟引擎：

- `ISimulationStage` - 可扩展阶段接口
- `SimulationEngine` - 基于时间步的协调器
- 内置阶段：`AttractionCalculationStage`, `MigrationDecisionStage`, `MigrationExecutionStage`
- `ISimulationObserver` - 用于监控的观察者模式（包含 `ConsoleObserver`）

### 快照层（`/src/Snapshot`）

类似 Git 的增量快照系统：

- 存储初始世界状态 + 模拟步骤（增量）
- 支持 JSON 和 XML 序列化
- 通过迁移事件记录实现高效存储

## 贡献

欢迎提交贡献、bug 报告或功能建议，请通过 issue 或开 PR 提交。
